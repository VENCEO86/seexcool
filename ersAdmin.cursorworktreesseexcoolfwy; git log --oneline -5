#!/bin/bash

# -----------------------------
# 1) Python í™•ì¸ ë° ì„¤ì • (Render ê¸°ë³¸ Python ì‚¬ìš©)
# -----------------------------
echo "ğŸ“Œ Python í™˜ê²½ í™•ì¸ ì¤‘..."

# Renderì— ì´ë¯¸ ì„¤ì¹˜ëœ Python ì‚¬ìš© (root ê¶Œí•œ ë¶ˆí•„ìš”)
PYTHON_CMD="python3"
PIP_CMD="python3 -m pip"

# Python ë²„ì „ í™•ì¸
$PYTHON_CMD --version || echo "âš ï¸  python3ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. python ì‹œë„..."
if ! $PYTHON_CMD --version > /dev/null 2>&1; then
    PYTHON_CMD="python"
    PIP_CMD="python -m pip"
fi

$PYTHON_CMD --version
$PIP_CMD --version

# -----------------------------
# 2) requirements.txt ì„¤ì¹˜ (ê°€ìƒí™˜ê²½ ì‚¬ìš© - PEP 668 ëŒ€ì‘)
# -----------------------------
echo "ğŸ“Œ Python ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
$PYTHON_CMD -m venv venv || echo "âš ï¸  ê°€ìƒí™˜ê²½ ìƒì„± ì‹¤íŒ¨, --break-system-packages ì‚¬ìš©..."

if [ -d "venv" ]; then
    echo "ğŸ“Œ ê°€ìƒí™˜ê²½ í™œì„±í™” ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
    source venv/bin/activate
    pip install --upgrade pip || echo "âš ï¸  pip ì—…ê·¸ë ˆì´ë“œ ì‹¤íŒ¨, ê³„ì† ì§„í–‰..."
    pip install -r requirements.txt || echo "âš ï¸  requirements.txt ì„¤ì¹˜ ì‹¤íŒ¨, ê³„ì† ì§„í–‰..."
    deactivate
else
    echo "ğŸ“Œ ê°€ìƒí™˜ê²½ ì—†ì´ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„ (--break-system-packages)..."
    $PIP_CMD install --break-system-packages --upgrade pip || echo "âš ï¸  pip ì—…ê·¸ë ˆì´ë“œ ì‹¤íŒ¨, ê³„ì† ì§„í–‰..."
    $PIP_CMD install --break-system-packages -r requirements.txt || echo "âš ï¸  requirements.txt ì„¤ì¹˜ ì‹¤íŒ¨, ê³„ì† ì§„í–‰..."
fi

# -----------------------------
# 3) Node ì„œë²„ ì‹¤í–‰
# -----------------------------
echo "ğŸ“Œ Next.js ë¹Œë“œ í›„ ì‹¤í–‰"
npm install
npm run build
npm start